<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Etiquetas de Origen — v2</title>

<!-- Tipografías cálidas -->
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

<!-- Leaflet + geocoder -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

<style>
:root{
  --bg:#0e1d17; --bg2:#0b1713;
  --ink:#eaffe9; --muted:#cfead8;
  --accent:#4ec07a; --accent2:#2a9b63; --line:#1e3b2f;
  --card:#11261e; --chip:#0d2119;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); background:linear-gradient(180deg,var(--bg),var(--bg2) 60%);
  font-family:Quicksand,system-ui,Segoe UI,Roboto,Arial,sans-serif;
}
.app{max-width:1200px; margin:18px auto; padding:14px;}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.logo{width:42px;height:42px;border-radius:12px;background:
 radial-gradient(80% 80% at 25% 30%,#78f0b0 0 60%,transparent 61%),
 radial-gradient(80% 80% at 70% 70%,#1a6a45 0 60%,transparent 61%), var(--accent2);
box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.07);}
.header h1{margin:0;font-size:clamp(1.25rem,2.5vw,1.8rem);font-weight:700;letter-spacing:.2px}

.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
@media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

.card{background:linear-gradient(180deg,var(--card),#0f221b);
border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.35);overflow:hidden}
.card h2{margin:0;padding:12px 14px;font-size:1rem;background:linear-gradient(180deg,rgba(78,192,122,.12),transparent);border-bottom:1px solid var(--line)}
.card .body{padding:12px}

.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.label{font-size:.86rem;color:var(--muted);margin:8px 0 6px}
.input,.btn{width:100%;border-radius:12px;padding:11px 12px;font-size:.95rem}
.input{border:1px solid var(--line);background:#0a2017;color:var(--ink)}
.input::placeholder{color:#9ed1b7}
.btn{border:none;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#0a1a14;font-weight:800;cursor:pointer}
.btn.secondary{background:#0d231b;border:1px solid var(--accent2);color:var(--ink)}
.btn:disabled{opacity:.6;cursor:not-allowed}

#map{width:100%;height:400px;border-radius:12px;border:1px solid var(--line)}
.meta{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
.meta div{padding:8px 10px;background:#0a2219;border:1px solid var(--line);border-radius:10px;font-size:.9rem}
.meta b{display:block;color:#d2ffe7;font-size:.8rem;margin-bottom:2px}

hr.sep{border:0;height:1px;background:linear-gradient(90deg,transparent,#21563e,transparent);margin:10px 0}

.badge{font-size:.8rem;color:#d7ffe8;background:#0c261b;border:1px dashed #205c40;padding:6px 10px;border-radius:999px}

/* ETIQUETA (A5 aprox) */
.poster{padding:12px}
.sheet{
  width: 980px; max-width: 100%; margin:0 auto;
  background: radial-gradient(220% 100% at 0% 0%, rgba(109,197,152,.12) 0 40%, transparent 41%),
              radial-gradient(250% 140% at 100% 100%, rgba(109,197,152,.10) 0 35%, transparent 36%),
              #12261f;
  border:1px solid var(--line); border-radius:18px; padding:16px; position:relative;
  box-shadow:0 8px 18px rgba(0,0,0,.35);
}
.sheet:before, .sheet:after{
  content:""; position:absolute; inset:auto auto 16px 16px; width:68px; height:68px; opacity:.25;
  background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24" fill="none" stroke="%2376d6a8" stroke-width="1.2"><path d="M7 21c-4-4 0-9 5-9 0-5 5-9 9-5" /><path d="M5 19c-3-3 0-7 4-7 0-4 4-7 7-4"/></svg>') no-repeat center/contain;
}
.sheet:after{inset:16px 16px auto auto; transform:scaleX(-1)}

.brand{display:flex;gap:12px;align-items:center;margin-bottom:10px}
.brand-mark{width:42px;height:42px;border-radius:12px;background:
  radial-gradient(80% 80% at 25% 25%,#72f0ad 0 55%,transparent 56%),
  radial-gradient(80% 80% at 75% 75%,#1a6a45 0 60%,transparent 61%), var(--accent2);
  box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.08)}
.brand h3{margin:0;font-family:"Playfair Display",serif;font-weight:700;letter-spacing:.3px;
  font-size:clamp(1.2rem,2.2vw,1.6rem)}

.canvas{
  display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; align-items:start;
}
@media (max-width: 980px){ .canvas{grid-template-columns: 1fr; } }

.mapwrap{position:relative}
.mapimg{
  width:100%; border-radius:16px; border:1px solid var(--line);
  box-shadow:0 10px 24px rgba(0,0,0,.35);
}
.mapbadge{
  position:absolute;right:10px;top:10px;padding:6px 10px;border-radius:999px;
  background:#0f261d;border:1px solid #2a7e58;font-size:.8rem;color:#d7ffe8
}

.kv{display:grid;gap:8px}
.tile{background:#0d231b;border:1px solid var(--line);border-radius:12px;padding:10px}
.tile b{display:block;color:#d7ffe8;font-size:.82rem;margin-bottom:2px}
.subtitle{color:#c4ead6;margin:.2rem 0 .6rem;font-size:1.02rem}
.title{font-family:"Playfair Display",serif;font-weight:700;letter-spacing:.3px;font-size:1.5rem;margin:0 0 .2rem}
.footer{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;color:#9bd8bd}
.note{font-size:.8rem;color:#aee3c7}

/* PRINT: solo la hoja */
@media print{
  body{background:white}
  .app > :not(.print-area){display:none !important}
  .sheet{box-shadow:none;border:0;margin:0;padding:0;background:white}
  .sheet:before,.sheet:after{display:none}
  @page{size:A5;margin:8mm}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo" aria-hidden="true"></div>
    <h1>Etiquetas personalizadas de origen</h1>
  </div>

  <div class="grid">
    <!-- MAPA + FORM -->
    <section class="card">
      <h2>1) Ubica tu negocio y completa los datos</h2>
      <div class="body">
        <div id="map" aria-label="Mapa OSM interactivo"></div>
        <div class="row" style="margin-top:8px">
          <button id="btnLocate" class="btn secondary">Usar mi ubicación</button>
          <span class="badge">Tip: haz clic en el mapa para poner/ mover el pin.</span>
        </div>
        <div class="meta">
          <div><b>Latitud</b><span id="latOut">—</span></div>
          <div><b>Longitud</b><span id="lonOut">—</span></div>
        </div>
        <hr class="sep">
        <div class="row" style="gap:12px">
          <div style="flex:1">
            <div class="label">Nombre / Marca</div>
            <input id="inpMarca" class="input" placeholder="p. ej., Café La Montaña">
          </div>
          <div style="flex:1">
            <div class="label">Producto</div>
            <input id="inpProducto" class="input" placeholder="p. ej., Café especial">
          </div>
        </div>
        <div class="row" style="gap:12px">
          <div style="flex:1">
            <div class="label">Finca / Vereda / Ciudad (opcional)</div>
            <input id="inpLugar" class="input" placeholder="p. ej., Finca El Porvenir, Vereda Santa Rosa">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnGenerar" class="btn">Generar etiqueta</button>
          <button id="btnImprimir" class="btn secondary">Imprimir / PDF</button>
          <button id="btnPNG" class="btn secondary" title="Alternativa rápida">Descargar PNG</button>
        </div>
        <p class="note" style="margin:6px 0 0">Departamento/Municipio: Nominatim (OSM) · Altitud: Open-Meteo (fallback: OpenTopoData) · Clima 1991–2020: Open-Meteo.</p>
      </div>
    </section>

    <!-- ETIQUETA -->
    <section class="card print-area">
      <h2>2) Vista previa de tu etiqueta (A5)</h2>
      <div class="body">
        <div class="poster">
          <div class="sheet" id="sheet">
            <div class="brand">
              <div class="brand-mark" aria-hidden="true"></div>
              <h3 id="outMarca">Tu marca</h3>
            </div>
            <div class="canvas" id="canvasLabel">
              <div class="mapwrap">
                <img id="imgStaticMap" class="mapimg" alt="Mapa de la ubicación">
                <span class="mapbadge" id="badgeCoords">—</span>
              </div>
              <div>
                <div class="title" id="outProducto">Producto</div>
                <div class="subtitle" id="outOrigen">Origen</div>
                <div class="kv">
                  <div class="tile"><b>Departamento</b><span id="outDpto">—</span></div>
                  <div class="tile"><b>Municipio</b><span id="outMuni">—</span></div>
                  <div class="tile"><b>Altitud</b><span id="outAlt">—</span></div>
                  <div class="tile"><b>Temp. media</b><span id="outTmean">—</span></div>
                  <div class="tile"><b>Fecha</b><span id="outFecha">—</span></div>
                </div>
                <p class="note" style="margin-top:8px">Hecho con cariño en Colombia • Datos abiertos</p>
              </div>
            </div>
          </div><!-- /sheet -->
        </div>
      </div>
    </section>
  </div>
</div>

<!-- LIBRERÍAS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const $ = s => document.querySelector(s);

// Salidas etiqueta
const outMarca = $('#outMarca'), outProducto = $('#outProducto'), outOrigen = $('#outOrigen');
const outDpto = $('#outDpto'), outMuni = $('#outMuni'), outAlt = $('#outAlt'), outTmean = $('#outTmean'), outFecha = $('#outFecha');
const badgeCoords = $('#badgeCoords'), imgStatic = $('#imgStaticMap');

// Meta cruda
const latOut = $('#latOut'), lonOut = $('#lonOut');

// Fecha humana
outFecha.textContent = new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});

// ---------- MAPA ----------
const map = L.map('map', { zoomControl: true }).setView([4.65,-74.1], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);

// Geocoder (buscador)
if (L.Control && L.Control.geocoder){
  const geocoder = L.Control.geocoder({ defaultMarkGeocode:false, placeholder:'Buscar lugar…' })
    .on('markgeocode', e => {
      const c = e.geocode.center; setLatLon(c.lat, c.lng); map.setView(c, 14); placeMarker(c);
    }).addTo(map);
}

// Marcador + eventos
let marker = null;
function placeMarker(latlng){
  if(!marker){
    marker = L.marker(latlng,{draggable:true}).addTo(map);
    marker.on('dragend', () => {
      const {lat,lng} = marker.getLatLng(); setLatLon(lat,lng); refreshStatic();
    });
  }else{
    marker.setLatLng(latlng);
  }
  setLatLon(latlng.lat, latlng.lng);
  refreshStatic();
}
map.on('click', e => { placeMarker(e.latlng); });

document.getElementById('btnLocate').onclick = () => {
  if(!navigator.geolocation){ alert('Tu navegador no permite geolocalización.'); return; }
  navigator.geolocation.getCurrentPosition(p=>{
    const {latitude, longitude} = p.coords;
    const ll = L.latLng(latitude, longitude);
    map.setView(ll, 15); placeMarker(ll);
  }, ()=> alert('No fue posible obtener tu ubicación.'));
};

function setLatLon(lat, lon){
  latOut.textContent = Number(lat).toFixed(6);
  lonOut.textContent = Number(lon).toFixed(6);
  badgeCoords.textContent = `${Number(lat).toFixed(5)}, ${Number(lon).toFixed(5)}`;
}

// ---------- DATOS ABIERTOS ----------
async function getReverse(lat, lon){
  // Nominatim – OSM
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1&zoom=12&accept-language=es`;
  const r = await fetch(url, {headers:{'Accept':'application/json'}, cache:'no-store'});
  if(!r.ok) throw new Error('Nominatim error');
  const j = await r.json();
  const a = j.address || {};
  return {
    dpto: a.state || a.region || a.province || '—',
    muni: a.municipality || a.city || a.town || a.village || a.county || '—'
  };
}

async function getElevation(lat, lon){
  // Primario: Open-Meteo Elevation
  try{
    const u = `https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lon}`;
    const r = await fetch(u, {cache:'no-store'}); if(r.ok){
      const j = await r.json();
      if(j?.elevation?.[0] != null) return Math.round(j.elevation[0]);
    }
  }catch{}
  // Fallback: OpenTopoData (ETOPO1)
  try{
    const u = `https://api.opentopodata.org/v1/etopo1?locations=${lat},${lon}`;
    const r = await fetch(u, {cache:'no-store'}); if(r.ok){
      const j = await r.json();
      const v = j?.results?.[0]?.elevation;
      if(Number.isFinite(v)) return Math.round(v);
    }
  }catch{}
  return null;
}

async function getTMean(lat, lon){
  // Open-Meteo Climate (promedio mensual 1991–2020)
  const u = `https://climate-api.open-meteo.com/v1/climate?latitude=${lat}&longitude=${lon}&start_year=1991&end_year=2020&temperature_2m_mean=1`;
  const r = await fetch(u, {cache:'no-store'});
  if(!r.ok) return null;
  const j = await r.json();
  const arr = j?.monthly?.temperature_2m_mean || j?.data?.temperature_2m_mean;
  if(Array.isArray(arr) && arr.length){
    const mean = arr.reduce((a,b)=>a+(+b),0)/arr.length;
    return Number.isFinite(mean) ? Number(mean.toFixed(1)) : null;
  }
  return null;
}

// ---------- MAPA ESTÁTICO “LINDO” ----------
function staticMapURL(lat, lon, z=14, w=900, h=620){
  // Servicio público OSM StaticMap — estilizado ligero + marcador
  // Nota: para uso intensivo conviene cambiar a un proveedor con API key.
  const base = 'https://staticmap.openstreetmap.de/staticmap.php';
  const params = new URLSearchParams({
    center:`${lat},${lon}`, zoom:z, size:`${w}x${h}`,
    // marcador verde claro
    markers:`${lat},${lon},lightgreen1`
  });
  return `${base}?${params.toString()}`;
}
function refreshStatic(){
  const lat = parseFloat(latOut.textContent), lon = parseFloat(lonOut.textContent);
  if(Number.isFinite(lat) && Number.isFinite(lon)){
    imgStatic.src = staticMapURL(lat, lon);
  }
}

// ---------- PIPELINE DE GENERACIÓN ----------
document.getElementById('btnGenerar').onclick = async () => {
  const marca = document.getElementById('inpMarca').value.trim() || 'Tu marca';
  const prod  = document.getElementById('inpProducto').value.trim() || 'Producto';
  const lugar = document.getElementById('inpLugar').value.trim();

  outMarca.textContent = marca;
  outProducto.textContent = prod;

  const lat = parseFloat(latOut.textContent), lon = parseFloat(lonOut.textContent);
  if(!Number.isFinite(lat) || !Number.isFinite(lon)){
    alert('Selecciona primero un punto en el mapa.'); return;
  }

  // Reverse
  let dpto='—', muni='—';
  try{ const r = await getReverse(lat,lon); dpto=r.dpto; muni=r.muni; }catch{ /* graceful */ }
  outDpto.textContent = dpto; outMuni.textContent = muni;

  // Altitud
  outAlt.textContent = '…';
  const elev = await getElevation(lat,lon);
  outAlt.textContent = (elev==null) ? '—' : `${elev} m s.n.m.`;

  // Temperatura media
  outTmean.textContent = '…';
  const tmean = await getTMean(lat,lon);
  outTmean.textContent = (tmean==null) ? '—' : `${tmean} °C`;

  // Origen compuesto
  const origen = [lugar, muni, dpto].filter(Boolean).filter(x=>x!=='—').join(' · ');
  outOrigen.textContent = origen || '—';

  // Mapa central
  refreshStatic();
};

// ---------- Exportar ----------
document.getElementById('btnImprimir').onclick = () => window.print();
document.getElementById('btnPNG').onclick = async () => {
  const node = document.getElementById('sheet');
  try{
    const canvas = await html2canvas(node, {useCORS:true,backgroundColor:null,scale:2});
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png'); a.download = 'etiqueta_origen.png'; a.click();
  }catch{ alert('No se pudo generar PNG. Usa Imprimir/PDF.'); }
};

// Estado inicial (mapa estático “neutro” sobre Bogotá)
(function init(){
  const start = L.latLng(4.65,-74.1);
  map.setView(start, 6);
  refreshStatic();
})();
</script>
</body>
</html>
